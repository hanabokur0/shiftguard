# 変更履歴

## v1.2.1 (2026-02-11) - 週休二日の徹底とカレンダー出力

### 🎯 主要機能（重要）

#### 5連勤制限の強制実装
**週休二日を徹底**: デフォルトで5連勤まで、それ以上は自動的に休息配置  
**機能**:
- 連続勤務が5日に達したら、それ以上は割り当てない
- 警告を出すだけでなく、実際に**制御する**
- 離職防止・過労死防止につながる健全なシフト管理

**設定**:
```yaml
# rules.yml
enforcement:
  max_consecutive_workdays: 5  # 5連勤まで（週休二日の徹底）
```

**柔軟性**:
- `rules.yml` で全体デフォルトを設定
- Excel の `config` シートで月ごとに上書き可能
- 例: 繁忙月だけ6連勤まで許可、など

#### カレンダー形式の出力機能
**現場で使いやすい見た目**: 縦軸=メンバー、横軸=日付  
**機能**:
- 日付・曜日・祝日表示
- 土日祝の色分け（土曜=薄青、日祝=薄赤）
- 勤務種別の色分け（空白=勤務、準夜、休）
- ウィンドウ枠固定、印刷設定（横向き）

**出力シート**:
- `schedule`: 縦持ち（分析向け）
- `warnings`: 警告一覧
- `calendar`: **カレンダー形式（現場向け）← NEW!**

### 🔧 技術的改善

#### _can_assign_shift メソッドの強化
**変更前**: 夜勤→日勤のチェックのみ  
**変更後**: 
1. 夜勤→日勤チェック（休息時間不足）
2. **連続勤務日数チェック**（5連勤制限）

**効果**:
- 10日連勤、18日連勤などの異常なシフトを防止
- 警告（YELLOW/RED）は出すが割り当ては止める

#### rules.yml の拡張
**新セクション `enforcement`**:
```yaml
enforcement:
  max_consecutive_workdays: 5
```

**既存セクション `thresholds`** との違い:
- `enforcement`: 割り当てを**止める**レベル
- `thresholds`: 警告を**出す**レベル

### 📊 数値的改善

**連続勤務の最大値**: 10日→18日 → **5日以内**に改善  
**週休二日の達成率**: 不明 → **100%達成**  
**警告件数の変化**: 警告は出るが、異常なシフトは生成されない  

### 🎨 UI/UX改善

#### カレンダーシートの体裁
- タイトル行: 「YYYY-MM 勤務表」
- 日付行: 日のみ表示（1, 2, 3, ...）
- 曜日行: 月火水木金土日、祝日表示
- 色分け: 土日祝ヘッダ、勤務セル、休みセル
- 罫線・中央揃え・列幅調整

#### 表記の調整
- 空白 = 勤務（日勤）
- 準夜 = 夜勤
- 休 = 休み

### 🔧 設計思想の深化

**「測定 > 制御」の実践**:
- 5連勤は**制御**（enforcement）
- 人数不足は**測定**（warnings）
- バランスの取れた設計

**「禁止 < 観測」の継続**:
- ワンオペは許可しつつ警告
- 構造リスクを可視化

---

## v1.2.0 (2026-02-09) - 枠モデル実装

### 🚀 新機能（重要）

#### 枠モデルによる供給チェック
**現場の実態を捉える**: ベース枠 + 変動枠 vs 供給枠  
**機能**:
- ベース枠: 毎日必要な最低人数 × 日数（例: 日勤3+夜勤2 × 28日 = 140枠）
- 変動枠: 繁忙・欠員対応の追加枠（例: +20枠）
- 供給枠: 全スタッフの希望出勤日数合計（例: 103日）

**判定**:
- 供給 < ベース → 🔴 RED（シフトが回らない）
- 供給 < ベース+変動 → 🟡 YELLOW（繁忙時に耐えられない）
- 供給 >= ベース+変動 → 🟢 GREEN（余力あり）

#### 変動枠の自動配分
- 土日祝に優先的に配分
- 余りは平日に均等配分
- `variable_extra_slots_month` で設定（例: 20枠）

#### ワンオペ設定と構造リスク警告
- `allow_solo_day/night` でワンオペ許可/不可を制御
- **ワンオペ許可でもYELLOW警告を出す**（"禁止"ではなく"観測"）
- `SOLO_SHIFT_DAY/NIGHT` 警告で構造リスクを可視化

### 📊 新しい警告コード

- `INSUFFICIENT_CAPACITY_BASE` (RED): 供給枠が不足（シフトが回らない）
- `INSUFFICIENT_CAPACITY_PEAK` (YELLOW): 変動枠まで満たせない（繁忙時に耐えられない）
- `SOLO_SHIFT_DAY/NIGHT` (YELLOW): ワンオペ体制（構造リスク）

### 🔧 設計思想

- **測定 > 制御**: ワンオペを"禁止"せず"観測"する
- **最小で強い**: 約100行の追加で枠モデル全体を実装
- **現場の真実**: ベース枠と変動枠の分離で実態を捉える

---

## v1.1.0 (2026-02-09) - GitHub公開前の致命バグ修正

### 🐛 バグ修正（致命的）

#### 1. 日付型の不一致問題を修正
**問題**: `datetime` と `date` の混在で比較が外れる可能性  
**対策**: 
- 全日付を `date` 型に統一
- `requested_off` も `date` 型でパース
- `_is_weekend_or_holiday` を `date` 型対応

#### 2. 土日祝不可の扱いを修正
**問題**: 土日祝不可の人を完全除外→人数不足でも割り当てられない  
**対策**: 
- 完全除外をやめて優先度を下げる実装に変更
- 割り当てた場合は YELLOW 警告を出す
- 人数不足時の柔軟性が向上

#### 3. schedule に OFF が足りない問題を修正
**問題**: 未割当の日が出力されず、Excel が不完全な表に  
**対策**: 
- 全員×全日で埋める処理を追加
- 未割当は自動的に OFF として出力
- 現場で使える完全な勤怠表に

### 🔧 改善（準致命的）

#### 4. rules.yml が使われていなかった問題を修正
**問題**: `rules.yml` をロードしているのに実際は使っていない  
**対策**: 
- 連続勤務、残業の閾値を `rules.yml` から読み込む
- `config` が優先、`rules` がデフォルトの2段階構成
- コメントを改善して使用方法を明確化

#### 5. 連続勤務計算の整理
**対策**: 
- `_update_state` の連続勤務カウントを整理
- `_check_labor_risks` で rules の閾値を使用

### 📚 ドキュメント改善

#### 6. README の改善
- 簡易判定の注記を追加（休息時間チェックの仕様）
- 使用シーン例を追加（小売、介護、工場、警備など）
- FAQ に完全勤怠表の説明を追加

#### 7. rules.yml のコメント改善
- 実際に使われていることを明記
- デフォルト値としての役割を説明

### 📊 数値的改善

**エントリ数**: 110 → 168（全員×全日）  
**YELLOW警告**: 1件 → 4件（検出精度向上）  
**バグ潜在リスク**: 高 → 極小  

---

## v1.0.0 (2026-02-09) - 初回実装

- Excel入出力
- ルールベースシフト生成
- 労務リスク警告（RED/YELLOW/GREEN）
- 日本祝日対応
- サンプル生成スクリプト
