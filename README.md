# ShiftGuard

**労務リスク警告付き簡易シフト生成ツール**

ローカル完結・ルールベースで、Excelから読み込んでExcelに出力する最小構成のシフト管理ツールです。

## ⚠️ 重要な免責事項

このツールは簡易的なシフト生成および労務リスク警告を提供するものです。

- **法的な助言ではありません**
- 最終的な判断は管理者・担当者の責任で行ってください
- 労働基準法、就業規則、36協定などの確認は必須です
- 本ツールの使用により生じた問題について、作者は一切の責任を負いません

## 特徴

✅ **API不要**: 完全ローカル実行  
✅ **Excel I/O**: 非エンジニアでも扱いやすい  
✅ **労務リスク警告**: RED/YELLOW/GREENの3段階で警告  
✅ **設定ファイル**: YAMLで柔軟にルール調整可能  
✅ **日本の祝日対応**: jpholidayライブラリで自動判定  
✅ **業界横断**: 小売、介護、工場、警備、コールセンターなど多様な現場で利用可能

### 使用シーン例

- **小売店舗**: 土日繁忙、学生アルバイトの希望休管理
- **介護施設**: 夜勤対応、連続勤務制限、資格者配置
- **工場**: 3交替制、土日祝の稼働管理
- **警備**: 24時間体制、夜勤シフト
- **コールセンター**: 繁忙時間帯の人員配置
- **電力会社**: 夜間監視、休日対応（サンプルデータ）  

## インストール

### 必要環境
- Python 3.11以上
- pip

### セットアップ

```bash
# リポジトリをクローン
git clone <このリポジトリURL>
cd shiftguard

# 依存パッケージをインストール
pip install pandas openpyxl pyyaml jpholiday
```

## 使い方

### 1. サンプル入力ファイルを生成

```bash
python generate_sample.py --output sample_input.xlsx --month 2026-02
```

生成される`sample_input.xlsx`には以下が含まれます：
- `staff`シート: スタッフ情報
- `config`シート: シフト生成の設定

### 2. シフトを生成

```bash
python shiftguard.py --input sample_input.xlsx --output result.xlsx
```

### 3. 結果を確認

`result.xlsx`を開くと2つのシートがあります：

- **`schedule`シート**: 生成されたシフト表
- **`warnings`シート**: 労務リスク警告一覧

## 入力Excel仕様

### staffシート

| 列名 | 型 | 必須 | 説明 | 例 |
|------|-----|------|------|-----|
| staff_id | 文字列 | ○ | スタッフID | A001 |
| name | 文字列 | ○ | 氏名 | 田中太郎 |
| role | 文字列 | - | 役割・職種 | 正社員 |
| desired_days | 整数 | ○ | 希望勤務日数 | 18 |
| can_day | 0/1 | ○ | 日勤可否 | 1 |
| can_night | 0/1 | ○ | 夜勤可否 | 1 |
| can_weekend_holiday | 0/1 | ○ | 土日祝可否 | 1 |
| requested_off_dates | 文字列 | - | 希望休日（カンマ区切り） | 2026-02-11,2026-02-23 |

### configシート

| 列名 | 型 | 必須 | 説明 | 例 |
|------|-----|------|------|-----|
| month | 文字列 | ○ | 対象月（YYYY-MM） | 2026-02 |
| min_staff_day | 整数 | ○ | 日勤の最低必要人数（ベース枠） | 3 |
| min_staff_night | 整数 | ○ | 夜勤の最低必要人数（ベース枠） | 2 |
| variable_extra_slots_month | 整数 | - | 変動枠（繁忙・欠員対応の追加枠） | 20 |
| allow_solo_day | 0/1 | - | 日勤ワンオペ許可（0=不可、1=可） | 0 |
| allow_solo_night | 0/1 | - | 夜勤ワンオペ許可（0=不可、1=可） | 0 |
| max_consecutive_workdays | 整数 | ○ | 連続勤務日数上限 | 6 |
| min_rest_hours | 整数 | ○ | 最低休息時間 | 11 |
| max_month_overtime_hours | 整数 | ○ | 月間残業上限（推定） | 45 |
| standard_day_shift_hours | 数値 | ○ | 日勤の標準時間 | 8 |
| standard_night_shift_hours | 数値 | ○ | 夜勤の標準時間 | 10 |

### 枠モデルとは

ShiftGuardは「枠モデル」で現場の実態を捉えます：

**ベース枠**：  
毎日必ず必要な最低人数 × 日数  
例）日勤3人 + 夜勤2人 × 28日 = 140枠

**変動枠**：  
繁忙日・イベント・欠員対応の追加枠  
例）+20枠 → 土日祝に優先配分

**供給枠**：  
全スタッフの希望出勤日数の合計  
例）6人の希望日数が 20+18+15+16+22+12 = 103日

**判定**：
- 供給 < ベース → 🔴 RED（シフトが回らない）
- 供給 < ベース+変動 → 🟡 YELLOW（繁忙時に耐えられない）
- 供給 >= ベース+変動 → 🟢 GREEN（余力あり）

## 出力Excel仕様

### scheduleシート

| 列名 | 説明 | 例 |
|------|------|-----|
| date | 日付 | 2026-02-01 |
| shift_type | シフト種別 | DAY / NIGHT / OFF |
| staff_id | スタッフID | A001 |
| name | 氏名 | 田中太郎 |

### warningsシート

| 列名 | 説明 | 例 |
|------|------|-----|
| severity | 深刻度 | RED / YELLOW / GREEN |
| code | 警告コード | REQUESTED_OFF_VIOLATION |
| message | 警告メッセージ | 希望休に勤務が割り当てられています |
| evidence | 該当データ | 田中太郎 (2026-02-11) |

## 労務リスク警告の種類

### 🔴 RED（重大）

- **INSUFFICIENT_CAPACITY_BASE**: 供給枠が不足（シフトが回らない）
- **REQUESTED_OFF_VIOLATION**: 希望休に勤務割り当て
- **UNDERSTAFFED_DAY/NIGHT**: 必要人数不足
- **INSUFFICIENT_REST**: 休息時間不足（夜勤→日勤など）
- **EXCESSIVE_CONSECUTIVE**: 連続勤務日数が過剰
- **EXCESSIVE_OVERTIME**: 推定残業時間が過剰

### 🟡 YELLOW（要注意）

- **INSUFFICIENT_CAPACITY_PEAK**: 変動枠まで満たせない（繁忙時に耐えられない）
- **SOLO_SHIFT_DAY/NIGHT**: ワンオペ体制（構造リスク）
- **HIGH_CONSECUTIVE**: 連続勤務日数が多い
- **HIGH_OVERTIME**: 推定残業時間が上限に近い
- **WEEKEND_RESTRICTION**: 土日祝不可のスタッフに土日祝勤務

### 🟢 GREEN（問題なし）

- **ALL_CLEAR**: 重大な労務リスクなし

## ルール設定のカスタマイズ

`rules.yml`を編集することで、警告のしきい値を調整できます：

```yaml
thresholds:
  max_consecutive_workdays:
    yellow: 6    # この日数を超えたらYELLOW
    red: 8       # この日数を超えたらRED
  
  max_month_overtime_hours:
    yellow: 45
    red: 54
```

## シフト生成ロジック

このツールは以下の順序でシフトを生成します：

1. **枠モデル分析**: ベース枠・変動枠・供給枠を計算し、供給が足りるかチェック
2. **変動枠の配分**: 変動枠を土日祝に優先的に配分（足りなければ平日にも均等配分）
3. **希望休の確保**: 各スタッフの希望休日を先にOFFで埋める
4. **人数充足の試行**: 日勤・夜勤それぞれの必要人数（変動枠込み）を満たすよう割り当て
5. **希望日数の考慮**: まだ希望日数に達していないスタッフを優先
6. **制約チェック**: 土日祝可否、日勤/夜勤可否、休息時間などを確認
7. **未割当をOFF化**: 割り当てられなかった日は自動的にOFFとして埋める
8. **リスク警告**: 生成後に労務リスクを全件チェック

### 枠モデルの例

**ケース1: 余力あり 🟢**
```
ベース枠: 140 (日勤3+夜勤2 × 28日)
変動枠: +20
合計必要: 160
供給枠: 180 (全員の希望日数合計)
→ GREEN: 余力 20枠
```

**ケース2: 繁忙に耐えられない 🟡**
```
ベース枠: 140
変動枠: +20
合計必要: 160
供給枠: 150
→ YELLOW: 変動枠が10枠不足
```

**ケース3: シフトが回らない 🔴**
```
ベース枠: 140
変動枠: +20
合計必要: 160
供給枠: 120
→ RED: ベース枠すら20枠不足
```

### 簡易判定の注意点

**休息時間チェック**:  
実際の休息時間は勤務開始/終了時刻が必要ですが、このツールは日単位の管理のため以下のように簡易判定します：
- **夜勤→日勤**: 原則として不可（11時間未満と仮定）
- **日勤→夜勤**: 許可（十分な休息があると仮定）

より厳密な管理が必要な場合は、時刻管理システムとの併用を推奨します。

**土日祝不可の扱い**:  
- 土日祝不可のスタッフは優先度を下げますが、人数不足の場合は割り当てます
- 割り当てた場合は必ずYELLOW警告を出します

**ワンオペの扱い**:  
- `allow_solo_day/night = 1` でワンオペを許可できます
- ワンオペ許可でも SOLO_SHIFT_* として YELLOW 警告を出します
- これは「禁止」ではなく「構造リスクの観測」です（事故率・離職率を可視化）

**注意**: このツールは「最適化」ではなく「成立するシフトの試行」を目指します。人員不足や制約が厳しい場合は、警告が多く出る可能性があります。

## よくある質問

### Q: 祝日判定がうまくいかない

A: `jpholiday`がインストールされているか確認してください：

```bash
pip install jpholiday
```

### Q: 人数不足の警告が多い

A: 以下を確認してください：
- スタッフ数が十分か
- `can_day`/`can_night`/`can_weekend_holiday`の設定は適切か
- `desired_days`の合計が必要な総勤務日数を満たしているか

### Q: 連続勤務が多すぎる

A: `config`シートの`max_consecutive_workdays`を調整するか、スタッフを増やしてください。

### Q: スケジュールにOFFの行が多い

A: **これは正常です**。全員×全日の完全な勤怠表を出力しているため、勤務がない日もOFFとして記録されます。これにより：
- 休みなのか未割当なのかが明確
- Excelで集計・フィルタが容易
- 勤怠管理として完全な記録

### Q: カスタマイズしたい

A: `shiftguard.py`と`rules.yml`を自由に編集してください。GitHubでフォーク・プルリクエストも歓迎です。

## 技術情報

- **言語**: Python 3.11+
- **依存**: pandas, openpyxl, pyyaml, jpholiday
- **アルゴリズム**: ルールベース（貪欲法的割り当て）
- **最適化**: なし（将来の拡張で対応予定）

## ライセンス

MIT License

このツールは自由に使用・改変・再配布できます。ただし無保証です。

## 貢献

バグ報告・機能要望・プルリクエストを歓迎します！

## 作者

ShiftGuard開発チーム

---

**最後に**: このツールは「完璧なシフト」ではなく「現場で使える第一歩」を目指しています。  
実際の運用では、生成されたシフトを必ず確認・調整してください。
